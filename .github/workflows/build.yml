name: Build

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  MIX_ENV: test
  ELIXIR_VERSION: "1.18"
  OTP_VERSION: "27"
  NODE_VERSION: "20"

jobs:
  # =============================================================================
  # Elixir Backend Tests
  # =============================================================================
  elixir:
    name: Elixir Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}

      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-${{ env.ELIXIR_VERSION }}-${{ env.OTP_VERSION }}-${{ hashFiles('mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-${{ env.ELIXIR_VERSION }}-${{ env.OTP_VERSION }}-
            ${{ runner.os }}-mix-

      - name: Install dependencies
        run: mix deps.get

      - name: Check formatting
        run: mix format --check-formatted

      - name: Compile with warnings as errors
        run: mix compile --warnings-as-errors

      - name: Run tests
        run: mix test

  # =============================================================================
  # Frontend Tests
  # =============================================================================
  frontend:
    name: Frontend Build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: apps/leaxer_ui

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: apps/leaxer_ui/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: apps/leaxer_ui/dist
          retention-days: 7

  # =============================================================================
  # Validate Dependency Versions
  # =============================================================================
  validate-deps:
    name: Validate Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Validate deps.versions.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          if [[ ! -f deps.versions.json ]]; then
            echo "deps.versions.json not found, skipping validation"
            exit 0
          fi

          echo "=== Validating dependency versions ==="

          # Read all versions
          REPOS=("leaxer-llama" "leaxer-stable-diffusion" "leaxer-grounding-dino" "leaxer-sam" "leaxer-realesrgan")
          ERRORS=0

          for repo in "${REPOS[@]}"; do
            version=$(jq -r ".[\"$repo\"]" deps.versions.json)

            if [[ "$version" == "null" || -z "$version" ]]; then
              echo "Warning: $repo not found in deps.versions.json"
              continue
            fi

            echo -n "Checking $repo@$version... "

            # Check if the release exists
            if gh release view "$version" --repo "leaxer-ai/$repo" &>/dev/null; then
              echo "OK"
            else
              echo "FAILED - release not found"
              ERRORS=$((ERRORS + 1))
            fi
          done

          echo ""
          if [[ $ERRORS -gt 0 ]]; then
            echo "ERROR: $ERRORS dependency version(s) could not be validated"
            echo "Make sure all releases exist in the respective repositories"
            exit 1
          fi

          echo "All dependency versions validated successfully"
